{"version":3,"sources":["../../routes/file.js"],"names":["RESP","express","require","router","Router","multiparty","util","fs","crypto","post","req","res","next","form","Form","encoding","uploadDir","__dirname","maxFilesSize","parse","err","fields","files","filesTmp","JSON","stringify","onFailed","console","log","appName","app_name","replace","length","appId","app_id","appType","app_type","appVersion","app_version","application","apkFile","uploadedPath","path","fileDir","isFolderExist","existsSync","fileList","readdirSync","map","fileName","unlinkSync","mkdirSync","renameSync","originalFilename","database","updateAppVersion","then","result","onSuccess","catch","toString","md5","createHash","id","update","Date","now","digest","iconFile","icon","mkdir","error","rename","insertApp","close","module","exports"],"mappings":"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","file":"file.js","sourcesContent":["import * as RESP from '../core/resp_func';\r\nimport DataBase from '../core/module';\r\n\r\n//1.首先加载express\r\nlet express = require('express');\r\n//2.获取路由\r\nlet router = express.Router();\r\nvar multiparty = require('multiparty');\r\nvar util = require('util');\r\nvar fs = require('fs');\r\nvar crypto = require('crypto');\r\n\r\n//3.对路由对象进行get post方法的配置\r\n//更新app\r\nrouter.post('/update', function (req, res, next) {\r\n    // 解析一个文件上传\r\n    var form = new multiparty.Form();\r\n    //设置编辑\r\n    form.encoding = 'utf-8';\r\n    //设置文件存储路径\r\n    form.uploadDir = __dirname + '\\\\..\\\\..\\\\public\\\\apk';\r\n    //设置单文件大小限制\r\n    form.maxFilesSize = 50 * 1024 * 1024;\r\n    //form.maxFields = 1000;  设置所以文件的大小总和\r\n    //生成multiparty对象，并配置上传目标路径\r\n    //上传完成后处理\r\n    form.parse(req, function (err, fields, files) {\r\n        var filesTmp = JSON.stringify(files, null, 2);\r\n\r\n        if (err) {\r\n            RESP.onFailed(res, 101, err);\r\n            console.log('parse error: ' + err);\r\n        } else {\r\n            var appName = fields.app_name[0];\r\n            if (appName.replace(/(^s*)|(s*$)/g, \"\").length == 0) {\r\n                RESP.onFailed(res, \"app名字不能为空\");\r\n                return;\r\n            }\r\n\r\n            var appId = fields.app_id[0];\r\n            if (appId.replace(/(^s*)|(s*$)/g, \"\").length == 0) {\r\n                RESP.onFailed(res, \"appId不能为空\");\r\n                return;\r\n            }\r\n\r\n            var appType = fields.app_type[0];\r\n            if (appType.replace(/(^s*)|(s*$)/g, \"\").length == 0) {\r\n                RESP.onFailed(res, \"appType不能为空\");\r\n                return;\r\n            }\r\n\r\n            var appVersion = fields.app_version[0];\r\n            if (appVersion.replace(/(^s*)|(s*$)/g, \"\").length == 0) {\r\n                RESP.onFailed(res, \"appType不能为空\");\r\n                return;\r\n            }\r\n\r\n            if (!files.application) {\r\n                RESP.onFailed(res, \"上传的apk不能为空\");\r\n                return;\r\n            }\r\n\r\n            var apkFile = files.application[0];\r\n            var uploadedPath = apkFile.path;\r\n\r\n            var fileDir = './public/apk/' + appId + '/' + appType;\r\n            var isFolderExist = fs.existsSync(fileDir);\r\n            if (isFolderExist) {\r\n                var fileList = fs.readdirSync(fileDir);\r\n                fileList.map(function (fileName) {\r\n                    fs.unlinkSync(fileDir + '/' + fileName);\r\n                });\r\n            } else {\r\n                fs.mkdirSync('./public/apk/' + appId + '/' + appType);\r\n            }\r\n            //重命名为真实文件名\r\n            fs.renameSync(uploadedPath, fileDir + '/' + apkFile.originalFilename);\r\n            let database = new DataBase();\r\n            database.updateAppVersion(appId, appType, '/' + 'apk/' + appId + '/' + appType + '/' + apkFile.originalFilename, appVersion)\r\n                .then((result) => {\r\n                    RESP.onSuccess(res, apkFile.originalFilename + '文件上传成功');\r\n                }).catch((err) => {\r\n                    console.log(err);\r\n                    RESP.onFailed(res, apkFile.originalFilename + '文件上传失败 : ' + err.toString());\r\n            });\r\n        }\r\n    });\r\n});\r\n\r\nrouter.post('/add', function (req, res, next) {\r\n    // 解析一个文件上传\r\n    var form = new multiparty.Form();\r\n    //设置编辑\r\n    form.encoding = 'utf-8';\r\n    //设置文件存储路径\r\n    form.uploadDir = __dirname + '\\\\..\\\\..\\\\public\\\\apk';\r\n    //设置单文件大小限制\r\n    form.maxFilesSize = 50 * 1024 * 1024;\r\n    //form.maxFields = 1000;  设置所以文件的大小总和\r\n    //生成multiparty对象，并配置上传目标路径\r\n    //上传完成后处理\r\n    form.parse(req, function (err, fields, files) {\r\n        var filesTmp = JSON.stringify(files, null, 2);\r\n\r\n        if (err) {\r\n            RESP.onFailed(res, err);\r\n            console.log('parse error: ' + err);\r\n        } else {\r\n            console.log('parse files: ' + filesTmp);\r\n\r\n            var appName = fields.app_name[0];\r\n            if (appName.replace(/(^s*)|(s*$)/g, \"\").length == 0) {\r\n                RESP.onFailed(res, \"app名字不能为空\");\r\n                return;\r\n            }\r\n\r\n            var appVersion = fields.app_version[0];\r\n            if (appVersion.replace(/(^s*)|(s*$)/g, \"\").length == 0) {\r\n                RESP.onFailed(res, \"app版本号不能为空\");\r\n                return;\r\n            }\r\n\r\n            var md5 = crypto.createHash('md5');\r\n            var id = md5.update(Date.now() + '').digest('hex');\r\n            var iconFile = files.icon[0];\r\n            var uploadedPath = iconFile.path;\r\n            fs.mkdir('./public/apk/' + id.toString(), function (err) {\r\n                if (err) {\r\n                    return console.error(err);\r\n                }\r\n                //重命名为真实文件名\r\n                fs.rename(uploadedPath, './public/apk/' + id + '/' + iconFile.originalFilename, function (err) {\r\n                    if (err) {\r\n                        RESP.onFailed(res, \"添加失败\");\r\n                    } else {\r\n                        var database = new DataBase();\r\n                        database.insertApp(id, appName, 'apk/' + id + '/' + iconFile.originalFilename, appVersion)\r\n                            .then((result) => {\r\n                                RESP.onSuccess(res, '添加app成功');\r\n                                database.close();\r\n                            }).catch((err) => {\r\n                            console.log(err);\r\n                            RESP.onSuccess(res, '添加app失败');\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n});\r\nmodule.exports = router;\r\n"]}